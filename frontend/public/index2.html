<!DOCTYPE html>
<html lang="th">
<head>
    <title>esp8266 Web Server</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        
        body {
            background-color: #d5f6db;
            position: relative; 
        }
        
        .refresh-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            justify-content: center;
            align-items: center;
            background-color: #b0e49c;
            padding: 20px;
            border-radius: 8px;
            /* box-shadow: 0 0 30px rgba(209, 18, 18, 0.1); */
            width: 300px;
            
        }

        .refresh-container:hover{
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            justify-content: center;
            align-items: center;
            background-color: #79c55b;
            padding: 20px;
            border-radius: 8px;
            /* box-shadow: 0 0 30px rgb(223, 10, 10); */
            width: 300px;
            
        }
        .refresh-container button{
             width: 100%;
            padding: 10px;
            background-color: #398c4f;
            border: none;
            border-radius: 4px;
            color: #f7f9f7;
            font-size: 16px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .refresh-container button:hover {
            background-color: #68fa5b;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .refresh-container p{
            font-size: 36px;
        }

        .log-out button{
            width: 10%;
            padding: 10px;
            background-color: #007bff;
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 16px;
            position: fixed; 
            right: 0; 
            margin-right: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .log-out button:hover{
            width: 10%;
            padding: 10px;
            background-color: #0056b3;
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 16px;
            position: absolute; 
            right: 0; 
            margin-right: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 1);
            
        }
        body {background: #7cb684;}

        /* leaf animations */

        #leaves {position:relative;top:-50px;width:100%;text-align: right;}

        #leaves i {
            display: inline-block;
            width: 200px;
            height: 150px;
            background: linear-gradient(to bottom right, #309900, #005600);
            transform: skew(20deg);
            border-radius: 5% 40% 70%;
            box-shadow: inset 0px 0px 1px #222;
            border: 1px solid #333;
            z-index: 1;
            -webkit-animation: falling 5s 0s infinite;
        }

        #leaves i:nth-of-type(2n) { -webkit-animation: falling2 5s 0s infinite; }
        #leaves i:nth-of-type(3n) { -webkit-animation: falling3 5s 0s infinite; }

        #leaves i:before {
        position: absolute;
        content: '';
        top: 117px;
        right: 9px;
        height: 27px;
        width: 32px;
        transform: rotate(49deg);
        border-radius: 0% 15% 15% 0%;
        border-top: 1px solid #222;
        border-bottom: 1px solid #222;
        border-left: 0px solid #222;
        border-right: 1px solid #222;
        background: linear-gradient(to right, rgba(0,100,0,1), #005600);
        z-index: 1;
        }

        #leaves i:after {
        content: '';
        height: 125px;
        width: 10px;
        background: linear-gradient(to right, rgba(0,0,0,.15), rgba(0,0,0,0));
        display: block;
        transform: rotate(125deg);
        position: absolute;
        left: 85px;
        border-radius:50%;
        }


        #leaves i:nth-of-type(n)    { height:23px; width:30px; }
        #leaves i:nth-of-type(n):before { width:7px; height:5px; top:17px; right:1px; }
        #leaves i:nth-of-type(n):after { width:2px; height:17px; left: 12px; top:0px; }

        #leaves i:nth-of-type(2n+1)    { height:11px; width:16px; }
        #leaves i:nth-of-type(2n+1):before { width:4px; height:3px; top:7px; right:0px; }
        #leaves i:nth-of-type(2n+1):after { width:2px; height:6px; left: 5px; top:1px; }

        #leaves i:nth-of-type(3n+2)  { height:17px; width:23px; }
        #leaves i:nth-of-type(3n+2):before  { height:4px; width:4px; top:12px; right:1px; }
        #leaves i:nth-of-type(3n+2):after  { height:10px; width:2px; top:1px; left:8px; }

        #leaves i:nth-of-type(n)   { -webkit-animation-delay: 1.9s;}
        #leaves i:nth-of-type(2n)  { -webkit-animation-delay: 3.9s;}
        #leaves i:nth-of-type(3n)  { -webkit-animation-delay: 2.3s;}
        #leaves i:nth-of-type(4n)  { -webkit-animation-delay: 4.4s;}
        #leaves i:nth-of-type(5n)  { -webkit-animation-delay: 5s;  }
        #leaves i:nth-of-type(6n)  { -webkit-animation-delay: 3.5s;}
        #leaves i:nth-of-type(7n)  { -webkit-animation-delay: 2.8s;}
        #leaves i:nth-of-type(8n)  { -webkit-animation-delay: 1.5s;}
        #leaves i:nth-of-type(9n)  { -webkit-animation-delay: 3.3s;}
        #leaves i:nth-of-type(10n) { -webkit-animation-delay: 2.5s;}
        #leaves i:nth-of-type(11n) { -webkit-animation-delay: 1.2s;}
        #leaves i:nth-of-type(12n) { -webkit-animation-delay: 4.1s;}
        #leaves i:nth-of-type(13n) { -webkit-animation-delay: 1s;  }
        #leaves i:nth-of-type(14n) { -webkit-animation-delay: 4.7s;}
        #leaves i:nth-of-type(15n) { -webkit-animation-delay: 3s;  }

        #leaves i:nth-of-type(n)    { background: linear-gradient(to bottom right, #309900, #005600); }
        #leaves i:nth-of-type(2n+2)  { background: linear-gradient(to bottom right, #5e9900, #2b5600); }
        #leaves i:nth-of-type(4n+1)  { background: linear-gradient(to bottom right, #990, #564500); }

        #leaves i:nth-of-type(n)    { opacity: .7;}
        #leaves i:nth-of-type(3n+1)  { opacity: .5;}
        #leaves i:nth-of-type(3n+2)  { opacity: .3;}

        #leaves i:nth-of-type(n)    {transform: rotate(180deg);}


        #leaves i:nth-of-type(n) { -webkit-animation-timing-function:ease-in-out;}

        @-webkit-keyframes falling {
            
            0% {
                -webkit-transform:
                    translate3d(300,0,0)
                    rotate(0deg);
            }
            
            100% {
                -webkit-transform:
                    translate3d(-350px,700px,0)
                    rotate(90deg);
                opacity: 0;
            }
        }

        @-webkit-keyframes falling3 {
            0% {
                -webkit-transform:
                    translate3d(0,0,0)
                    rotate(-20deg);
            }
            
            100% {
                -webkit-transform:
                    translate3d(-230px,640px,0)
                    rotate(-70deg);
                opacity: 0;
            }
        }

        @-webkit-keyframes falling2 {
            0% {
                -webkit-transform:
                    translate3d(0,0,0)
                    rotate(90deg);
            }
            
            100% {
                -webkit-transform:
                    translate3d(-400px,680px,0)
                    rotate(0deg);
                opacity: 0;
            }
        }
        /* Droplet animation */
        .droplet {
            position: relative;
            left: 370px; /* Move the droplet 50px to the right */
            width: 20px;
            height: 20px;
            background: #2196f3;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
            animation: fall 2s infinite ease-in;
        }

        .droplet::after {
            content: '';
            position: relative;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 10px;
            background: #2196f3;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
        }

        @keyframes fall {
            0% {
                top: -100px;
                opacity: 0;
                transform: scale(0.5);
            }
            50% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                top: 100vh;
                opacity: 0;
                transform: scale(0.5);
            }
        }

        .gif-container {
            position: relative;
            text-align: left;
        }

        .gif-container img {
            max-width: 50%;
            height: 40%;
        }
        .cat-container{
            position: relative; /* เพิ่มคำสั่ง position */
            bottom: 200px; /* เพิ่มค่า top เพื่อขยับขึ้น */
            right: 200px;
            text-align: right;
            
            
        }
        .cat-container img {
            max-width: 100%;
            height: 100%;
        }

        .helicopter {
            position: fixed;
            top: 20px;
            width: 100px;
            height: 50px;
            background: #013d06;
            border-radius: 10px 10px 5px 5px;
            animation: fly 5s infinite linear;
        }

        .helicopter::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 10px;
            background: #666;
            border-radius: 5px;
            animation: rotate-blade 0.2s infinite linear;
        }

        .helicopter::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            width: 20px;
            height: 4px;
            background: #666;
            border-radius: 2px;
        }

        .tail-rotor {
            position: absolute;
            top: 50%;
            left: calc(100% + 10px);
            transform: translateY(-50%);
            width: 10px;
            height: 2px;
            background: #666;
            animation: rotate-tail 0.2s infinite linear;
        }

        @keyframes rotate-blade {
            0% {
                transform: translateX(-50%) rotate(0deg);
            }
            100% {
                transform: translateX(-50%) rotate(360deg);
            }
        }

        @keyframes rotate-tail {
            0% {
                transform: translateY(-50%) rotate(0deg);
            }
            100% {
                transform: translateY(-50%) rotate(360deg);
            }
        }

        @keyframes fly {
            0% {
                left: -100px; /* Start off-screen to the left */
            }
            100% {
                left: 100vw; /* Move to off-screen to the right */
            }
        }
    </style>
</head>
<body>
    <!-- <button id="create">CreateLeave</button> -->
    <div id="leaves" style="position:absolute">
        
    </div>
    <div class = "refresh-container" id="showTemp">
        
        <button id="myfunction"> Refresh </button>
        <p> Temperature: <span id="temp">__</span> </p>
        <p> Humidity: <span id="humid">__</span> </p>
        <p> Point: <span id="point">__</span> </p>
    </div>

    <div class = "log-out">
        <button id = "logout">LOG OUT</button>
    </div>

    <div class="droplet"></div>
    <div class="gif-container">
        <img src="/source.gif" alt="Descriptive text for the GIF">
    </div>

    <div class="cat-container">
        <img src="/2019-cat-on-the-run-animation.gif" alt="CAT GIF">
    </div>

    <div class="helicopter">
        <div class="tail-rotor"></div>
    </div>

    <script type="module">
        
        // var prevHumidity = -1;
        async function getCurrentUser(){
            const curUser = await fetch(`http://localhost:3000/getCurrentUser`)
            .then(data => data.json());
            return await curUser;
        } 
        async function getUserData() {
            try {
                const data = await fetch(`http://localhost:3000/Netpie/testNetPie2`)
                .then(res => res.json());
                return await data.data;
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }
        document.getElementById('myfunction').addEventListener("click", myFunction)
        
        async function myFunction() {
            console.log("button was clicked!");
            const data = await getUserData();
            const curUser= await getCurrentUser();

            // console.log(typeof(data.data));
            // console.log(data.data);
            if (await data) {
                document.getElementById("temp").innerHTML = await data.Temperature;
                document.getElementById("humid").innerHTML = await data.Humidity;
                document.getElementById("point").innerHTML = await curUser.point;
                
                // Update points if the humidity condition is met
                
                    const getuserdata = await getUserData();
                    console.log(typeof(getuserdata.soil));
                    console.log(getuserdata.soil);
                    if (getuserdata.soil==true && localStorage.getItem("prevsoil")==false) {
                        //localstorage.clear or sth
                        
                        await fetch("http://localhost:3000/updatePoint?addPoint=true")
                            .then(res => res.json())
                            .then(pointData => console.log(pointData));
                    }
                    await localStorage.removeItem("prevsoil");
                    await localStorage.setItem("prevsoil",getuserdata);
                    // prevHumidity = parseInt(data.humidity);
                
            }
        }
        async function removeCurrentUser(){
            await fetch(`http://localhost:3000/removeCurrentUser`);
        }
        async function getRequest() {
            try {
                const response = await fetch("http://localhost:3000/");
                const curData = await getUserData();
                const data = await response.json();
                console.log(data);
                console.log(curData.soil)

            } catch (error) {
                console.error('Error updating point:', error);
            }
        }

        document.getElementById("logout").addEventListener("click", function () {
                // Redirect to the login page
                removeCurrentUser()
               location.href = "index.html";
               
            });

        document.addEventListener('DOMContentLoaded', myFunction, false);
        setInterval(getRequest, 500);
        // document.getElementById('create').addEventListener('click', createLeave);

        function createLeave(){
            const newElement = document.createElement('i');
            document.getElementById('leaves').appendChild(newElement);

        }
        const userData= await getCurrentUser();
        var pointUser = userData.point;
        var counter = 0;
        async function autoLeaves(){
            if(pointUser >= 100 && counter <= 30){
                pointUser -= 100;
                counter++;
                createLeave();
            }
            else{
                clearInterval(autoLeaves);
            }
        }
        setInterval(autoLeaves, 100);
        setBoxShadow();
        async function setBoxShadow(){
            console.log("Set Shadow")
            const Data = await getUserData();
            const temp = Data.Temperature;
            const strTemp = temp + "px";
            console.log(strTemp)
            console.log(typeof(strTemp));
            document.getElementById('showTemp').style.boxShadow = `0 0 ${strTemp} red`
        }
        setInterval(setBoxShadow, 4000);

    </script>
</body>
</html>
