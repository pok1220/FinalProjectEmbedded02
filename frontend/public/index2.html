<!DOCTYPE html>
<html lang="th">
<head>
    <title>esp8266 Web Server</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            background-color: #d5f6db; 
        }
        
        .refresh-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            justify-content: center;
            align-items: center;
            background-color: #b0e49c;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 300px;
            
        }

        .refresh-container:hover{
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            justify-content: center;
            align-items: center;
            background-color: #79c55b;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 1);
            width: 300px;
            
        }
        .refresh-container button{
             width: 100%;
            padding: 10px;
            background-color: #398c4f;
            border: none;
            border-radius: 4px;
            color: #f7f9f7;
            font-size: 16px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .refresh-container button:hover {
            background-color: #68fa5b;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .refresh-container p{
            font-size: 36px;
        }


    </style>
</head>
<body>
    
    
    <div class = "refresh-container">
        <button id="myfunction"> Refresh </button>
        <p> Temperature: <span id="temp">__</span> </p>
        <p> Humidity: <span id="humid">__</span> </p>
        <p> Point: <span id="point">__</span> </p>
    </div>

    <script type="module">
        
        // var prevHumidity = -1;
        async function getCurrentUser(){
            const curUser = await fetch(`http://localhost:3000/getCurrentUser`)
            .then(data => data.json());
            return await curUser;
        } 
        async function getUserData() {
            try {
                const data = await fetch(`http://localhost:3000/Netpie/testNetPie2`)
                .then(res => res.json());
                return await data.data;
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }
        document.getElementById('myfunction').addEventListener("click", myFunction)
        
        async function myFunction() {
            console.log("button was clicked!");
            const data = await getUserData();
            const curUser= await getCurrentUser();

            // console.log(typeof(data.data));
            // console.log(data.data);
            if (await data) {
                document.getElementById("temp").innerHTML = await data.Temperature;
                document.getElementById("humid").innerHTML = await data.Humidity;
                document.getElementById("point").innerHTML = await curUser.point;
                // Update points if the humidity condition is met
                
                    const getuserdata = await getUserData();
                    console.log(typeof(getuserdata.soil));
                    console.log(getuserdata.soil);
                    if (getuserdata.soil==true && localStorage.getItem("prevsoil")==false) {
                        //localstorage.clear or sth
                        
                        await fetch("http://localhost:3000/updatePoint?addPoint=true")
                            .then(res => res.json())
                            .then(pointData => console.log(pointData));
                    }
                    await localStorage.removeItem("prevsoil");
                    await localStorage.setItem("prevsoil",getuserdata);
                    // prevHumidity = parseInt(data.humidity);
                
            }
        }

        async function getRequest() {
            try {
                const response = await fetch("http://localhost:3000/");
                const curData = await getUserData();
                const data = await response.json();
                console.log(data);
                console.log(curData.soil)

            } catch (error) {
                console.error('Error updating point:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', myFunction, false);
        setInterval(getRequest, 500);
    </script>
</body>
</html>
